<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>NeuroScan AI — Insights</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <header class="header">
    <div class="site header-inner">
      <div class="brand">
        <svg xmlns="http://www.w3.org/2000/svg" height="40px" viewBox="0 -960 960 960" width="40px" fill="#e3e3e3"><path d="M390-120q-51 0-88-35.5T260-241q-60-8-100-53t-40-106q0-21 5.5-41.5T142-480q-11-18-16.5-38t-5.5-42q0-61 40-105.5t99-52.5q3-51 41-86.5t90-35.5q26 0 48.5 10t41.5 27q18-17 41-27t49-10q52 0 89.5 35t40.5 86q59 8 99.5 53T840-560q0 22-5.5 42T818-480q11 18 16.5 38.5T840-400q0 62-40.5 106.5T699-241q-5 50-41.5 85.5T570-120q-25 0-48.5-9.5T480-156q-19 17-42 26.5t-48 9.5Zm130-590v460q0 21 14.5 35.5T570-200q20 0 34.5-16t15.5-36q-21-8-38.5-21.5T550-306q-10-14-7.5-30t16.5-26q14-10 30-7.5t26 16.5q11 16 28 24.5t37 8.5q33 0 56.5-23.5T760-400q0-5-.5-10t-2.5-10q-17 10-36.5 15t-40.5 5q-17 0-28.5-11.5T640-440q0-17 11.5-28.5T680-480q33 0 56.5-23.5T760-560q0-33-23.5-56T680-640q-11 18-28.5 31.5T613-587q-16 6-31-1t-20-23q-5-16 1.5-31t22.5-20q15-5 24.5-18t9.5-30q0-21-14.5-35.5T570-760q-21 0-35.5 14.5T520-710Zm-80 460v-460q0-21-14.5-35.5T390-760q-21 0-35.5 14.5T340-710q0 16 9 29.5t24 18.5q16 5 23 20t2 31q-6 16-21 23t-31 1q-21-8-38.5-21.5T279-640q-32 1-55.5 24.5T200-560q0 33 23.5 56.5T280-480q17 0 28.5 11.5T320-440q0 17-11.5 28.5T280-400q-21 0-40.5-5T203-420q-2 5-2.5 10t-.5 10q0 33 23.5 56.5T280-320q20 0 37-8.5t28-24.5q10-14 26-16.5t30 7.5q14 10 16.5 26t-7.5 30q-14 19-32 33t-39 22q1 20 16 35.5t35 15.5q21 0 35.5-14.5T440-250Zm40-230Z"/></svg>
        <span>NeuroScan AI</span>
      </div>

      <nav class="nav">
        <a href="index.html">Home</a>
        <a href="ai-scan.html">AI Scan</a>
        <a href="insights.html">Dashboard</a>
        <a href="about.html">About & Contact</a>
      </nav>

      <div class="header-right">
        <a class="btn" href="ai-scan.html">Get Started</a>
      </div>
    </div>
  </header>

  <main class="site page">
    <h2 class="page-title">Dashboard Insights</h2>
    <p class="page-subtitle">Visualize history from scans and tests — track risk level, scans, and changes over time.</p>

    <!-- ✅ Search Section -->
    <div class="cards-row">
      <div class="stat section" style="display:flex;flex-direction:column;gap:8px;">
        <h4>Search by Patient</h4>
        <div style="display:flex;gap:8px;align-items:center;">
          <input id="patientInput" type="text" placeholder="Enter patient name..." aria-label="Search Patient ID" style="padding:8px 10px;border:1px solid #516cc4;border-radius:6px;min-width:100px;flex:1;font-size:14px;">
          <button id="searchBtn" class="btn" style="padding:8px 14px;border-radius:6px;">Search</button>
        </div>
      </div>

      <!-- ✅ Dynamic Stats -->
      <div class="stat section">
        <h4>Total Scans</h4>
        <div id="totalScansText" class="green" style="font-weight:700;margin-top:8px;font-size:32px;">—</div>
      </div>

      <div class="stat section">
        <h4>Patient Name</h4>
        <div id="patientNameText" style="font-weight:700;margin-top:8px;font-size:20px;">—</div>
      </div>
    </div>

    <!-- ✅ Patient Info Card -->
    <div id="patientInfoCard" class="section" style="margin-top:18px;display:none;">
      <h4>Latest Scan Results</h4>
      <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px;margin-top:12px;">
        <div>
          <div class="muted small">Prediction</div>
          <div id="predictionText" style="font-weight:600;margin-top:4px;font-size:14px;">—</div>
        </div>
        <div>
          <div class="muted small">Confidence</div>
          <div id="riskText" class="green" style="font-weight:700;margin-top:4px;font-size:20px;">—</div>
        </div>
        <div>
          <div class="muted small">Last Scan Date</div>
          <div id="lastTestText" style="font-weight:600;margin-top:4px;">—</div>
        </div>
      </div>
    </div>

    <!-- ✅ Chart -->
    <div id="chartSection" class="chart section" style="margin-top:18px;display:none;">
      <h4>Predicted Class Progression Over Time</h4>
      <img id="chartImg" src="" alt="chart" style="width:100%;max-width:100%;height:auto;">
    </div>

    <!-- ✅ Scan History Table -->
    <div id="historySection" class="section" style="margin-top:18px;display:none;">
      <h4>Complete Scan History</h4>
      <div style="overflow-x:auto;margin-top:12px;">
        <table id="historyTable" style="width:100%;border-collapse:collapse;">
          <thead>
            <tr style="border-bottom:2px solid #516cc4;">
              <th style="padding:12px;text-align:left;">Date</th>
              <th style="padding:12px;text-align:left;">Prediction</th>
              <th style="padding:12px;text-align:center;">Confidence %</th>
            </tr>
          </thead>
          <tbody id="historyTableBody">
            <!-- Will be populated dynamically -->
          </tbody>
        </table>
      </div>
    </div>

    <!-- ✅ No Data Message -->
    <div id="noDataMessage" class="section" style="margin-top:18px;text-align:center;padding:40px;display:none;">
      <p class="muted">No patient data found. Please search for a patient name.</p>
    </div>
  </main>

  <footer class="footer site">
    <div class="small muted">2025 NeuroScan AI — Tracking minds intelligently</div>
  </footer>

  <!-- ✅ JavaScript to Connect Backend -->
  <script>
    const searchBtn = document.getElementById("searchBtn");
    const patientInput = document.getElementById("patientInput");
    
    // Elements
    const totalScansText = document.getElementById("totalScansText");
    const patientNameText = document.getElementById("patientNameText");
    const predictionText = document.getElementById("predictionText");
    const riskText = document.getElementById("riskText");
    const lastTestText = document.getElementById("lastTestText");
    const chartImg = document.getElementById("chartImg");
    const historyTableBody = document.getElementById("historyTableBody");
    
    // Sections
    const patientInfoCard = document.getElementById("patientInfoCard");
    const chartSection = document.getElementById("chartSection");
    const historySection = document.getElementById("historySection");
    const noDataMessage = document.getElementById("noDataMessage");

    searchBtn.addEventListener("click", async () => {
      const name = patientInput.value.trim();
      if (!name) return alert("Please enter a patient name!");

      try {
        // Show loading state
        searchBtn.textContent = "Searching...";
        searchBtn.disabled = true;

        const res = await fetch(`/api/patient/${name}/history`);
        const data = await res.json();

        if (res.status === 404 || data.message) {
          // No data found
          hideAllSections();
          noDataMessage.style.display = "block";
          noDataMessage.querySelector("p").textContent = data.message || "No records found for this patient.";
          return;
        }

        // Hide no data message and show sections
        noDataMessage.style.display = "none";
        patientInfoCard.style.display = "block";
        chartSection.style.display = "block";
        historySection.style.display = "block";

        // Update stats
        totalScansText.textContent = data.totalScans;
        patientNameText.textContent = data.name.charAt(0).toUpperCase() + data.name.slice(1);

        // Update latest scan info
        const latest = data.latestScan;
        predictionText.textContent = latest.prediction;
        riskText.textContent = `${(Number(latest.confidence || 0) * 100).toFixed(2)}%`;
        lastTestText.textContent = new Date(latest.date).toLocaleDateString('en-US', { 
          year: 'numeric', 
          month: 'long', 
          day: 'numeric' 
        });

        // Build stepped line chart with y-axis class names
        const classNames = ["Alzheimer's Disease","Cognitively Normal","Early MCI","Late MCI"];
        const lineLabels = data.timeline.map(t => t.date);
        const lineValues = data.timeline.map(t => (t.classIndex !== undefined && t.classIndex >= 0) ? t.classIndex : null);

        const chartUrl = `https://quickchart.io/chart?bkg=white&c=${encodeURIComponent(JSON.stringify({
          type: 'line',
          data: {
            labels: lineLabels,
            datasets: [{
              label: 'Predicted Class',
              data: lineValues,
              spanGaps: true,
              borderColor: 'rgb(81,108,196)',
              backgroundColor: 'rgba(81,108,196,0.25)',
              pointRadius: 5,
              pointHoverRadius: 7,
              stepped: true,
              tension: 0
            }]
          },
          options: {
            responsive: true,
            plugins: {
              legend: { display: true, position: 'top' },
              title: { display: true, text: 'Predicted Class Progression Over Time' },
              tooltip: { callbacks: { label: function(ctx){ const idx = ctx.parsed.y; return classNames[idx] || 'Unknown'; } } }
            },
            scales: {
              y: {
                min: 0,
                max: 3,
                ticks: { stepSize: 1, callback: function(value){ return classNames[value] || ''; } },
                title: { display: true, text: 'Class' }
              },
              x: { title: { display: true, text: 'Scan Date' } }
            }
          }
        }))}`;
        chartImg.src = chartUrl;

        // Populate history table
        historyTableBody.innerHTML = "";
        data.allRecords.reverse().forEach(record => {
          const row = document.createElement("tr");
          row.style.borderBottom = "1px solid #333";
          row.innerHTML = `
            <td style="padding:12px;">${new Date(record.scanDate).toLocaleDateString('en-US', { 
              year: 'numeric', 
              month: 'short', 
              day: 'numeric',
              hour: '2-digit',
              minute: '2-digit'
            })}</td>
            <td style="padding:12px;">${record.prediction.substring(0, 50)}...</td>
            <td style="padding:12px;text-align:center;font-weight:600;">${(Number(record.confidence || 0) * 100).toFixed(2)}%</td>
          `;
          historyTableBody.appendChild(row);
        });

      } catch (err) {
        console.error(err);
        alert("Error fetching patient data. Please check your connection.");
      } finally {
        searchBtn.textContent = "Search";
        searchBtn.disabled = false;
      }
    });

    function hideAllSections() {
      patientInfoCard.style.display = "none";
      chartSection.style.display = "none";
      historySection.style.display = "none";
    }

    // Allow search on Enter key
    patientInput.addEventListener("keypress", (e) => {
      if (e.key === "Enter") searchBtn.click();
    });
  </script>
</body>
</html>
